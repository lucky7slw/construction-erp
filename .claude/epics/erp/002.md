---
name: Database Schema & Authentication System
status: open
created: 2025-09-28T18:10:00Z
updated: 2025-09-28T18:10:00Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task 002: Database Schema & Authentication System

## Description

Design and implement the core database schema and authentication system for the ERP platform. This includes setting up PostgreSQL with Prisma ORM, implementing JWT-based authentication with role-based access control (RBAC), and creating the foundational data models that will support all ERP modules.

## Acceptance Criteria

- [ ] PostgreSQL database configured with proper indexing and constraints
- [ ] Prisma ORM setup with migrations and schema management
- [ ] Complete user authentication system with JWT tokens
- [ ] Role-based access control (RBAC) implementation
- [ ] Core entity schemas designed (Users, Companies, Projects, etc.)
- [ ] Database seeding scripts for development and testing
- [ ] Authentication middleware and route protection
- [ ] Password reset and email verification flows

## Technical Details

### Database Schema Core Entities

```typescript
// Core authentication and authorization
model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String   // bcrypt hashed
  firstName   String
  lastName    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  userRoles   UserRole[]
  companies   CompanyUser[]
  projects    ProjectUser[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Permission[]
  userRoles   UserRole[]
}

model Permission {
  id          String @id @default(cuid())
  name        String @unique
  resource    String // e.g., 'project', 'user', 'company'
  action      String // e.g., 'create', 'read', 'update', 'delete'
  roles       Role[]
}

// Business entities
model Company {
  id          String @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  createdAt   DateTime @default(now())

  users       CompanyUser[]
  projects    Project[]
}

model Project {
  id          String @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?
  companyId   String

  company     Company @relation(fields: [companyId], references: [id])
  users       ProjectUser[]
}
```

### Authentication Features
- JWT access tokens (15 min expiry) + refresh tokens (7 days)
- Password policies and bcrypt hashing
- Multi-factor authentication support (future)
- Session management and token blacklisting
- Rate limiting for auth endpoints

### RBAC System
- Hierarchical roles (Admin > Manager > User)
- Resource-based permissions
- Dynamic permission checking middleware
- Audit logging for sensitive operations

## Dependencies

- [001] Foundation Setup & Development Environment

## Effort Estimate

**Size**: Large (L)
**Hours**: 18-22 hours

### Breakdown:
- Database schema design and Prisma setup: 6 hours
- Authentication system implementation: 8 hours
- RBAC system development: 6 hours
- Testing and validation: 2 hours

## Definition of Done

- [ ] All database migrations run successfully in dev/staging environments
- [ ] User can register, login, and access protected routes
- [ ] Password reset flow works end-to-end with email
- [ ] RBAC system correctly restricts access based on user roles
- [ ] Database is properly indexed for performance
- [ ] Seed scripts populate realistic development data
- [ ] All authentication endpoints have comprehensive tests
- [ ] Security headers and rate limiting are implemented
- [ ] JWT tokens properly expire and refresh
- [ ] Database backup and recovery procedures documented